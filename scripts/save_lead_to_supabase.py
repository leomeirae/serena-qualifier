#!/usr/bin/env python3
"""
Script para salvar dados de lead no Supabase

Este script cont√©m duas fun√ß√µes principais:
1. main() - Para salvar dados iniciais do formul√°rio (usado pelos workflows Kestra)
2. save_qualified_lead() - Para salvar dados consolidados ap√≥s qualifica√ß√£o completa

MAPEAMENTO DEFINITIVO DOS CAMPOS:
- nomeCompleto ‚Üí name
- whatsapp ‚Üí phone_number  
- email ‚Üí additional_data.email (N√ÉO existe coluna email na tabela)
- faixaConta ‚Üí additional_data.faixaConta
- tipoCliente ‚Üí additional_data.tipoCliente
- city ‚Üí city (preenchido durante conversa)
- invoice_amount ‚Üí invoice_amount (extra√≠do do OCR)

Author: Serena-Coder AI Agent
Version: 2.0.0 - Task-2006: Adicionada fun√ß√£o save_qualified_lead()
"""

import os
import sys
import json
import logging
import argparse
from datetime import datetime
from typing import Dict, Any, Optional
from supabase import create_client, Client

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Tentar carregar .env como fallback se as vari√°veis n√£o estiverem dispon√≠veis
try:
    from dotenv import load_dotenv
    # Carregar .env do diret√≥rio raiz do projeto
    load_dotenv('/app/.env')
except ImportError:
    # Se python-dotenv n√£o estiver dispon√≠vel, continuar sem ele
    pass


def get_supabase_client() -> Client:
    """
    Cria e retorna cliente Supabase configurado.
    
    Returns:
        Client: Cliente Supabase configurado
        
    Raises:
        ValueError: Se credenciais n√£o estiverem dispon√≠veis
    """
    supabase_url = os.getenv('SUPABASE_URL')
    supabase_key = os.getenv('SUPABASE_KEY')
    
    if not supabase_url or not supabase_key:
        raise ValueError("SUPABASE_URL e SUPABASE_KEY devem estar configuradas nas vari√°veis de ambiente")
    
    return create_client(supabase_url, supabase_key)


def save_qualified_lead(lead_data: Dict[str, Any]) -> Dict[str, Any]:
    """
    Salva dados consolidados de um lead ap√≥s processo completo de qualifica√ß√£o.
    
    Esta fun√ß√£o √© chamada ao final do fluxo de conversa√ß√£o quando todos os dados
    foram coletados: localiza√ß√£o, dados da conta de energia, promo√ß√µes consultadas.
    
    Args:
        lead_data (Dict[str, Any]): Dicion√°rio com dados consolidados do lead:
            - phone_number (str): N√∫mero do lead (obrigat√≥rio)
            - name (str): Nome extra√≠do da conta ou fornecido
            - city (str): Cidade detectada na conversa
            - state (str): Estado detectado na conversa
            - extracted_data (Dict): Dados extra√≠dos da conta de energia
            - promotions (List): Promo√ß√µes encontradas para a localiza√ß√£o
            - conversation_completed (bool): Se a conversa foi finalizada
            
    Returns:
        Dict[str, Any]: Resultado da opera√ß√£o:
            - success (bool): Se a opera√ß√£o foi bem-sucedida
            - lead_id (str): ID do lead atualizado (se sucesso)
            - error (str): Mensagem de erro (se falha)
            
    Raises:
        Exception: Para erros cr√≠ticos de conex√£o ou dados inv√°lidos
    """
    try:
        logger.info(f"üíæ Salvando lead qualificado: {lead_data.get('phone_number')}")
        
        # Validar dados obrigat√≥rios
        if not lead_data.get('phone_number'):
            raise ValueError("phone_number √© obrigat√≥rio")
        
        # Extrair dados da conta de energia
        extracted_data = lead_data.get('extracted_data', {})
        if isinstance(extracted_data, dict) and 'data' in extracted_data:
            bill_data = extracted_data['data']
        else:
            bill_data = {}
        
        # Preparar dados para atualiza√ß√£o
        update_data = {
            'city': lead_data.get('city'),
            'state': lead_data.get('state'),
            'qualification_status': 'QUALIFIED' if lead_data.get('conversation_completed') else 'IN_PROGRESS',
            'conversation_state': 'COMPLETED' if lead_data.get('conversation_completed') else 'BILL_PROCESSED',
            'updated_at': datetime.now().isoformat()
        }
        
        # Adicionar valor da conta se extra√≠do
        if bill_data.get('valor_total'):
            # Extrair valor num√©rico do formato "R$ 245,67"
            import re
            valor_match = re.search(r'[\d,]+', str(bill_data['valor_total']))
            if valor_match:
                valor_str = valor_match.group().replace(',', '.')
                try:
                    update_data['invoice_amount'] = float(valor_str)
                except ValueError:
                    logger.warning(f"‚ö†Ô∏è N√£o foi poss√≠vel converter valor: {bill_data['valor_total']}")
        
        # Atualizar nome se extra√≠do da conta
        if bill_data.get('cliente_nome') and bill_data['cliente_nome'] != 'N√ÉO_IDENTIFICADO':
            update_data['name'] = bill_data['cliente_nome']
        
        # Consolidar dados adicionais
        current_additional_data = lead_data.get('additional_data', {})
        
        # Dados da conta de energia
        if bill_data:
            current_additional_data['conta_energia'] = {
                'cliente_nome': bill_data.get('cliente_nome'),
                'valor_total': bill_data.get('valor_total'),
                'consumo_kwh': bill_data.get('consumo_kwh'),
                'distribuidora': bill_data.get('distribuidora'),
                'vencimento': bill_data.get('vencimento'),
                'endereco': bill_data.get('endereco'),
                'numero_instalacao': bill_data.get('numero_instalacao'),
                'data_processamento': datetime.now().isoformat()
            }
        
        # Dados das promo√ß√µes
        promotions = lead_data.get('promotions', [])
        if promotions:
            current_additional_data['promocoes'] = {
                'total_encontradas': len(promotions),
                'lista_promocoes': promotions,
                'data_consulta': datetime.now().isoformat()
            }
        
        # Dados da conversa
        current_additional_data['conversa'] = {
            'finalizada': lead_data.get('conversation_completed', False),
            'data_finalizacao': datetime.now().isoformat() if lead_data.get('conversation_completed') else None,
            'modelo_usado': lead_data.get('model_used', 'gpt-4o-mini'),
            'processamento_imagem': lead_data.get('media_processed', False)
        }
        
        update_data['additional_data'] = current_additional_data
        
        # Conectar ao Supabase e atualizar lead
        supabase = get_supabase_client()
        
        logger.info(f"üîÑ Atualizando lead no Supabase: {lead_data['phone_number']}")
        
        result = supabase.table('leads').update(update_data).eq(
            'phone_number', lead_data['phone_number']
        ).execute()
        
        if result.data and len(result.data) > 0:
            lead_record = result.data[0]
            logger.info(f"‚úÖ Lead qualificado salvo com sucesso! ID: {lead_record['id']}")
            
            return {
                'success': True,
                'lead_id': lead_record['id'],
                'phone_number': lead_record['phone_number'],
                'qualification_status': lead_record['qualification_status'],
                'conversation_state': lead_record['conversation_state'],
                'updated_fields': list(update_data.keys())
            }
        else:
            logger.error(f"‚ùå Nenhum lead encontrado para atualizar: {lead_data['phone_number']}")
            return {
                'success': False,
                'error': f"Lead n√£o encontrado: {lead_data['phone_number']}"
            }
            
    except Exception as e:
        logger.error(f"‚ùå Erro ao salvar lead qualificado: {str(e)}")
        return {
            'success': False,
            'error': f"Erro ao salvar lead: {str(e)}"
        }


def main():
    """Fun√ß√£o principal para salvar lead no Supabase"""
    
    # Parser para os campos REAIS do formul√°rio da landing page
    parser = argparse.ArgumentParser(description='Salva dados de lead no Supabase')
    parser.add_argument('--name', required=True, help='nomeCompleto do formul√°rio')
    parser.add_argument('--phone', required=True, help='whatsapp do formul√°rio')
    parser.add_argument('--email', required=False, help='email do formul√°rio')
    parser.add_argument('--account_value', required=False, help='faixaConta do formul√°rio')
    parser.add_argument('--client_type', required=False, help='tipoCliente do formul√°rio')
    
    args = parser.parse_args()
    
    # Credenciais Supabase
    supabase_url = os.getenv('SUPABASE_URL')
    supabase_key = os.getenv('SUPABASE_KEY')
    
    if not supabase_url or not supabase_key:
        print("‚ùå ERRO: Vari√°veis SUPABASE_URL e SUPABASE_KEY n√£o encontradas")
        sys.exit(1)
    
    print("üíæ SALVANDO LEAD NO SUPABASE:")
    print(f"üìù Nome: {args.name}")
    print(f"üì± WhatsApp: {args.phone}")
    print(f"üìß Email: {args.email}")
    print(f"üí∞ Faixa Conta: {args.account_value}")
    print(f"üè† Tipo Cliente: {args.client_type}")
    
    try:
        # Conectar ao Supabase
        supabase: Client = create_client(supabase_url, supabase_key)
        
        # ESTRUTURA DEFINITIVA DA TABELA LEADS:
        lead_data = {
            # CAMPOS DIRETOS DA TABELA
            'phone_number': args.phone,           # Campo obrigat√≥rio √∫nico
            'name': args.name,                    # nomeCompleto ‚Üí name
            'city': None,                         # Ser√° perguntado DEPOIS na conversa
            'invoice_amount': None,               # Ser√° processado pelo OCR
            'conversation_state': 'FORM_SUBMITTED',
            
            # DADOS DO FORMUL√ÅRIO NO CAMPO JSON
            'additional_data': {
                'email': args.email,              # email N√ÉO tem coluna pr√≥pria
                'faixaConta': args.account_value, # valor bruto do formul√°rio
                'tipoCliente': args.client_type,  # casa/empresa
                'source': 'landing_page',
                'form_timestamp': datetime.now().isoformat(),
                'status_formulario': 'completo'
            }
        }
        
        print("üîÑ Inserindo dados na tabela 'leads'...")
        
        # Inserir no Supabase
        result = supabase.table('leads').insert(lead_data).execute()
        
        if result.data and len(result.data) > 0:
            lead_record = result.data[0]
            print(f"‚úÖ SUCESSO! Lead salvo com ID: {lead_record['id']}")
            print(f"üìû Phone Number: {lead_record['phone_number']}")
            print(f"üë§ Name: {lead_record['name']}")
            print(f"üè¢ Status: {lead_record['qualification_status']}")
            
            # Outputs para o pr√≥ximo task do Kestra
            print(f"::set-output name=lead_id::{lead_record['id']}")
            print(f"::set-output name=phone_number::{lead_record['phone_number']}")
            print(f"::set-output name=lead_name::{lead_record['name']}")
            
        else:
            print("‚ùå ERRO: Nenhum dado retornado ap√≥s inser√ß√£o")
            sys.exit(1)
            
    except Exception as e:
        print(f"‚ùå ERRO CR√çTICO ao salvar lead: {e}")
        print(f"üîç Detalhes do erro: {type(e).__name__}")
        sys.exit(1)


if __name__ == "__main__":
    main() 