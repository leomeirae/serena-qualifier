# Servidor MCP para API de Parcerias Serena

## üìã Vis√£o Geral

Este √© um servidor MCP (Model Context Protocol) que permite que assistentes de IA interajam com a API de Parcerias da Serena atrav√©s de ferramentas estruturadas. O servidor est√° dispon√≠vel no endpoint: **http://mwc8k8wk0wg8o8s4k0w8scc4.157.180.32.249.sslip.io/**

### üéØ Objetivo
Fornecer uma interface padronizada para que agentes de IA possam:
- Consultar √°reas de opera√ß√£o para Gera√ß√£o Distribu√≠da (GD)
- Gerenciar leads de vendas
- Validar qualifica√ß√£o de clientes
- Criar contratos de energia solar
- Interagir com a API de Parcerias da Serena de forma estruturada

### ‚úÖ Status do Servidor
- **üü¢ Servidor MCP**: 100% Funcional
- **üü¢ Consultas**: Funcionando perfeitamente
- **üü¢ Autentica√ß√£o**: OK
- **üü¢ API Externa**: Funcionando
- **‚ö†Ô∏è Cadastro de Leads**: Requer valida√ß√µes espec√≠ficas (ver se√ß√£o de Valida√ß√µes)

## üõ†Ô∏è Ferramentas Dispon√≠veis

### üìç Gera√ß√£o Distribu√≠da (Distributed Generation)

#### 1. `consultar_areas_operacao_gd`
**Descri√ß√£o**: Consulta √°reas onde o servi√ßo de Gera√ß√£o Distribu√≠da est√° dispon√≠vel

**Par√¢metros**:
- `cidade` (string, opcional): Nome da cidade
- `estado` (string, opcional): Sigla do estado (ex: SP, RJ)
- `codigo_ibge` (string, opcional): C√≥digo IBGE da localidade

**Retorno**: Lista de √°reas de opera√ß√£o dispon√≠veis com informa√ß√µes de cobertura

**Exemplo de uso**:
```python
# Por cidade e estado
resultado = await consultar_areas_operacao_gd(
    cidade="S√£o Paulo", 
    estado="SP"
)

# Por c√≥digo IBGE
resultado = await consultar_areas_operacao_gd(
    codigo_ibge="3550308"
)
```

**Exemplo de resposta**:
```json
{
  "result": [
    {
      "energyUtilityPublicId": "a06dcadc-fe16-44ee-b541-0c4658aa2d3e",
      "energyUtilityName": "ENEL SP",
      "ibgeCode": 3550308,
      "state": "SP",
      "city": "S√ÉO PAULO",
      "energyUtilityQualified": false
    }
  ]
}
```

#### 2. `obter_planos_gd`
**Descri√ß√£o**: Obt√©m planos de Gera√ß√£o Distribu√≠da dispon√≠veis para uma localidade

**Par√¢metros**:
- `id_distribuidora` (string, opcional): ID da distribuidora (prioridade)
- `cidade` (string, opcional): Nome da cidade
- `estado` (string, opcional): Sigla do estado

**Retorno**: Lista de planos dispon√≠veis com detalhes de desconto, fidelidade e benef√≠cios

**Exemplo de uso**:
```python
# Por ID da distribuidora
resultado = await obter_planos_gd(
    id_distribuidora="4c03af39-6fdc-4297-9153-fa2b36617c1b"
)

# Por cidade e estado
resultado = await obter_planos_gd(
    cidade="Recife",
    estado="PE"
)
```

**Exemplo de resposta**:
```json
{
  "result": [
    {
      "energyUtilityName": "CELPE",
      "plans": [
        {
          "id": 489,
          "name": "Plano B√°sico-14%",
          "fidelityMonths": 0,
          "discount": "0.14",
          "offeredBenefits": []
        },
        {
          "id": 556,
          "name": "Plano Premium-18%",
          "fidelityMonths": 60,
          "discount": "0.18",
          "offeredBenefits": [
            {
              "description": "Este contrato contempla o benef√≠cio da 1¬∞ fatura paga pela Serena."
            }
          ]
        }
      ]
    }
  ]
}
```

### üíº Convers√£o de Vendas (Sales Conversion)

#### 3. `cadastrar_lead`
**Descri√ß√£o**: Cadastra um novo lead na base de dados

**‚ö†Ô∏è IMPORTANTE**: Esta ferramenta requer valida√ß√µes espec√≠ficas (ver se√ß√£o de Valida√ß√µes de Neg√≥cio)

**Par√¢metros**:
- `dados_lead` (object, obrigat√≥rio): Objeto com todos os dados do lead

**Estrutura do dados_lead**:
```json
{
  "fullName": "string",
  "personType": "natural|juridical",
  "emailAddress": "string",
  "mobilePhone": "string",
  "utilityBillHolder": "natural|juridical",
  "utilityBillingValue": "number",
  "identificationNumber": "string",
  "nationality": "string",
  "maritalStatus": "string",
  "profession": "string",
  "zipCode": "string",
  "state": "string",
  "city": "string",
  "street": "string",
  "number": "string",
  "neighborhood": "string",
  "complement": "string",
  "plan": {
    "benefit": "string",
    "discount": "string",
    "loyaltyRequirement": "string",
    "planName": "string"
  }
}
```

**Retorno**: ID do lead criado e status da opera√ß√£o

**Exemplo de uso**:
```python
dados_lead = {
    "fullName": "Jo√£o Silva",
    "personType": "natural",
    "emailAddress": "joao@email.com",
    "mobilePhone": "11999885544",
    "utilityBillHolder": "natural",
    "utilityBillingValue": 800.00,
    "identificationNumber": "12345678901",
    "nationality": "Brasileiro",
    "maritalStatus": "Solteiro",
    "profession": "Engenheiro",
    "zipCode": "50030-230",
    "state": "PE",
    "city": "Recife",
    "street": "Avenida Conde da Boa Vista",
    "number": "800",
    "neighborhood": "Boa Vista"
}

resultado = await cadastrar_lead({"dados_lead": dados_lead})
```

#### 4. `buscar_leads`
**Descri√ß√£o**: Busca leads com filtros e pagina√ß√£o

**Par√¢metros**:
- `filtros` (string, opcional): Filtros para busca
- `pagina` (number, opcional): N√∫mero da p√°gina (padr√£o: 1)
- `limite` (number, opcional): Limite de resultados por p√°gina (padr√£o: 10)

**Retorno**: Lista paginada de leads com informa√ß√µes b√°sicas

**Exemplo de uso**:
```python
resultado = await buscar_leads(
    filtros="status:negociacao",
    pagina=1,
    limite=20
)
```

#### 5. `validar_qualificacao_lead`
**Descri√ß√£o**: Valida se um lead est√° qualificado para produtos de energia solar

**Par√¢metros**:
- `cidade` (string, obrigat√≥rio): Cidade do lead
- `estado` (string, obrigat√≥rio): Estado do lead
- `tipo_pessoa` (string, obrigat√≥rio): "natural" ou "juridical"
- `valor_conta` (number, obrigat√≥rio): Valor da conta de energia

**Retorno**: Resultado da valida√ß√£o com detalhes de qualifica√ß√£o

**Exemplo de uso**:
```python
resultado = await validar_qualificacao_lead(
    cidade="Recife",
    estado="PE",
    tipo_pessoa="natural",
    valor_conta=800.00
)
```

**Exemplo de resposta**:
```json
{
  "result": {
    "product": "Gera√ß√£o Distribu√≠da",
    "qualification": true
  }
}
```

#### 6. `buscar_lead_por_id`
**Descri√ß√£o**: Busca informa√ß√µes detalhadas de um lead espec√≠fico

**Par√¢metros**:
- `id_lead` (string, obrigat√≥rio): ID √∫nico do lead

**Retorno**: Informa√ß√µes completas do lead incluindo hist√≥rico e status

**Exemplo de uso**:
```python
resultado = await buscar_lead_por_id("lead_123456")
```

#### 7. `atualizar_lead`
**Descri√ß√£o**: Atualiza informa√ß√µes de um lead existente

**Par√¢metros**:
- `id_lead` (string, obrigat√≥rio): ID do lead
- `dados_atualizacao` (object, obrigat√≥rio): Dados a serem atualizados

**Retorno**: Confirma√ß√£o da atualiza√ß√£o

**Exemplo de uso**:
```python
dados_atualizacao = {
    "emailAddress": "novo_email@email.com",
    "mobilePhone": "11988776655"
}

resultado = await atualizar_lead("lead_123456", dados_atualizacao)
```

#### 8. `atualizar_credenciais_distribuidora`
**Descri√ß√£o**: Atualiza credenciais de acesso √† distribuidora de energia

**Par√¢metros**:
- `id_lead` (string, obrigat√≥rio): ID do lead
- `login` (string, obrigat√≥rio): Login da distribuidora
- `senha` (string, obrigat√≥rio): Senha da distribuidora

**Retorno**: Confirma√ß√£o da atualiza√ß√£o das credenciais

**Exemplo de uso**:
```python
resultado = await atualizar_credenciais_distribuidora(
    "lead_123456",
    "usuario_distribuidora",
    "senha_distribuidora"
)
```

#### 9. `criar_contrato`
**Descri√ß√£o**: Cria um contrato de gera√ß√£o distribu√≠da para um lead

**Par√¢metros**:
- `id_lead` (string, obrigat√≥rio): ID do lead
- `plano` (object, opcional): Dados do plano
- `representantes_legais` (array, opcional): Lista de representantes legais

**Retorno**: ID do contrato criado e status

**Exemplo de uso**:
```python
plano = {
    "id": 556,
    "name": "Plano Premium-18%",
    "discount": "0.18"
}

resultado = await criar_contrato("lead_123456", plano)
```

## ‚ö†Ô∏è Valida√ß√µes de Neg√≥cio Importantes

### üîç Qualifica√ß√£o de Leads
**CR√çTICO**: Leads devem estar qualificados antes do cadastro

#### Exemplos de Qualifica√ß√£o:
- **‚úÖ Recife, PE + R$ 800,00**: Qualificado
- **‚ùå S√£o Paulo, SP + R$ 500,00**: N√£o qualificado

#### Como Verificar:
```python
# Sempre verifique a qualifica√ß√£o antes do cadastro
qualificacao = await validar_qualificacao_lead(
    cidade="Recife",
    estado="PE", 
    tipo_pessoa="natural",
    valor_conta=800.00
)

if qualificacao["result"]["qualification"]:
    # Prosseguir com cadastro
    lead = await cadastrar_lead(dados_lead)
else:
    # Lead n√£o qualificado
    print("Lead n√£o qualificado para esta regi√£o/valor")
```

### üö´ Valida√ß√µes de Duplicidade
**IMPORTANTE**: A API rejeita leads duplicados

#### Campos √önicos:
- **Email**: N√£o pode existir na base
- **Telefone**: N√£o pode existir na base  
- **CPF/CNPJ**: Provavelmente tamb√©m √∫nico

#### Erros Comuns:
- `"Contact with email X already exists"`
- `"already exist lead, try update lead - X"`

### üìã Campos Obrigat√≥rios
**CR√çTICO**: Todos os campos obrigat√≥rios devem ser preenchidos

#### Para Pessoa F√≠sica:
- `fullName`, `personType`, `emailAddress`, `mobilePhone`
- `utilityBillHolder`, `utilityBillingValue`, `identificationNumber`
- `nationality`, `maritalStatus`, `profession`
- `zipCode`, `state`, `city`, `street`, `number`, `neighborhood`

#### Para Pessoa Jur√≠dica:
- Todos os campos acima + `companyName`

## üîß Configura√ß√£o para Agentes de IA

### Configura√ß√£o MCP

Para configurar este servidor MCP em um agente de IA, adicione a seguinte configura√ß√£o:

```json
{
  "mcpServers": {
    "serena-partnerships": {
      "command": "python",
      "args": ["servidor_parcerias_mcp.py"],
      "env": {
        "PARTNERSHIP_API_KEY": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQzNDBmZWEyLWM3ZTQtNGY1Ni1hYjdlLTAyMmE5ZDcwNTBiNiIsInBhcnRuZXJUeXBlIjoicGFydG5lcl9ncm91cCIsImlhdCI6MTc0NDgzNzEzOX0.YvvCD-I4GOSPmRduMoXit8Rw05c9ILoiCjhnPMgygO0",
        "PARTNERSHIP_API_ENDPOINT": "https://partnership-service-staging.api.srna.co/"
      }
    }
  }
}
```

### Configura√ß√£o para Claude Desktop

1. Abra as configura√ß√µes do Claude Desktop
2. V√° para a se√ß√£o "MCP Servers"
3. Adicione um novo servidor com as seguintes configura√ß√µes:
   - **Nome**: Serena Partnerships API
   - **Comando**: `python`
   - **Argumentos**: `servidor_parcerias_mcp.py`
   - **Diret√≥rio de trabalho**: Caminho para este projeto
   - **Vari√°veis de ambiente**: Configure as vari√°veis PARTNERSHIP_API_KEY e PARTNERSHIP_API_ENDPOINT

### Configura√ß√£o para Ollama

Adicione ao arquivo de configura√ß√£o do Ollama:

```yaml
mcp_servers:
  - name: serena-partnerships
    command: python
    args: [servidor_parcerias_mcp.py]
    env:
      PARTNERSHIP_API_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQzNDBmZWEyLWM3ZTQtNGY1Ni1hYjdlLTAyMmE5ZDcwNTBiNiIsInBhcnRuZXJUeXBlIjoicGFydG5lcl9ncm91cCIsImlhdCI6MTc0NDgzNzEzOX0.YvvCD-I4GOSPmRduMoXit8Rw05c9ILoiCjhnPMgygO0"
      PARTNERSHIP_API_ENDPOINT: "https://partnership-service-staging.api.srna.co/"
```

## üåê Endpoints da API

### Base URL
- **Staging**: `https://partnership-service-staging.api.srna.co/`
- **Produ√ß√£o**: `https://partnership.api.srna.co/`

### Mapeamento de Endpoints

| Ferramenta MCP | M√©todo HTTP | Endpoint | Descri√ß√£o |
|----------------|-------------|----------|-----------|
| `consultar_areas_operacao_gd` | GET | `/distribuited-generation/operation-areas` | Consulta √°reas de opera√ß√£o |
| `obter_planos_gd` | GET | `/distribuited-generation/plans` | Obt√©m planos dispon√≠veis |
| `cadastrar_lead` | POST | `/sales-conversion/leads` | Cadastra novo lead |
| `buscar_leads` | GET | `/sales-conversion/leads` | Lista leads com filtros |
| `validar_qualificacao_lead` | GET | `/sales-conversion/leads/qualification` | Valida qualifica√ß√£o |
| `buscar_lead_por_id` | GET | `/sales-conversion/leads/{id}` | Busca lead espec√≠fico |
| `atualizar_lead` | PUT | `/sales-conversion/leads/{id}` | Atualiza lead |
| `atualizar_credenciais_distribuidora` | PATCH | `/sales-conversion/leads/{id}/energy-utility-credentials` | Atualiza credenciais |
| `criar_contrato` | POST | `/sales-conversion/leads/{id}/contracts` | Cria contrato |

## üîê Autentica√ß√£o

Todas as requisi√ß√µes utilizam autentica√ß√£o Bearer Token:

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## üìä Estrutura de Dados

### Lead (Pessoa F√≠sica)
```json
{
  "fullName": "string",
  "personType": "natural",
  "emailAddress": "string",
  "mobilePhone": "string",
  "utilityBillHolder": "natural",
  "utilityBillingValue": "number",
  "identificationNumber": "string",
  "nationality": "string",
  "maritalStatus": "string",
  "profession": "string",
  "zipCode": "string",
  "state": "string",
  "city": "string",
  "street": "string",
  "number": "string",
  "neighborhood": "string",
  "complement": "string"
}
```

### Lead (Pessoa Jur√≠dica)
```json
{
  "fullName": "string",
  "personType": "juridical",
  "emailAddress": "string",
  "mobilePhone": "string",
  "utilityBillHolder": "juridical",
  "utilityBillingValue": "number",
  "identificationNumber": "string",
  "companyName": "string",
  "zipCode": "string",
  "state": "string",
  "city": "string",
  "street": "string",
  "number": "string",
  "neighborhood": "string",
  "complement": "string"
}
```

## üöÄ Casos de Uso

### 1. Processo de Vendas Completo
```python
# 1. Verificar se a √°rea tem cobertura
areas = await consultar_areas_operacao_gd(cidade="Recife", estado="PE")

# 2. Obter planos dispon√≠veis
planos = await obter_planos_gd(cidade="Recife", estado="PE")

# 3. Validar qualifica√ß√£o ANTES do cadastro
qualificacao = await validar_qualificacao_lead(
    cidade="Recife",
    estado="PE",
    tipo_pessoa="natural",
    valor_conta=800.00
)

# 4. Se qualificado, cadastrar lead
if qualificacao["result"]["qualification"]:
    dados_lead = {
        "fullName": "Jo√£o Silva",
        "personType": "natural",
        "emailAddress": "joao.unique@email.com",
        "mobilePhone": "11999885544",
        "utilityBillHolder": "natural",
        "utilityBillingValue": 800.00,
        "identificationNumber": "12345678901",
        "nationality": "Brasileiro",
        "maritalStatus": "Solteiro",
        "profession": "Engenheiro",
        "zipCode": "50030-230",
        "state": "PE",
        "city": "Recife",
        "street": "Avenida Conde da Boa Vista",
        "number": "800",
        "neighborhood": "Boa Vista"
    }
    
    lead = await cadastrar_lead({"dados_lead": dados_lead})
    print(f"Lead criado: {lead}")
else:
    print("Lead n√£o qualificado para esta regi√£o/valor")
```

### 2. Consulta de Leads Existentes
```python
# Buscar leads ativos
leads = await buscar_leads(limite=50)

# Para cada lead, buscar detalhes
for lead in leads["leads"]:
    detalhes = await buscar_lead_por_id(lead["id"])
    print(f"Lead: {detalhes['fullName']} - Status: {detalhes['status']}")
```

### 3. Atualiza√ß√£o em Lote
```python
# Buscar leads que precisam de atualiza√ß√£o
leads = await buscar_leads(filtros="status:pending_credentials")

# Atualizar credenciais
for lead in leads["leads"]:
    await atualizar_credenciais_distribuidora(
        lead["id"], 
        "novo_user",
        "nova_senha"
    )
```

## ‚ö†Ô∏è Tratamento de Erros

O servidor inclui tratamento robusto de erros:

### C√≥digos de Erro Comuns
- `400`: Dados inv√°lidos ou obrigat√≥rios ausentes
- `401`: Token de autentica√ß√£o inv√°lido
- `404`: Recurso n√£o encontrado
- `422`: Dados de valida√ß√£o inv√°lidos
- `500`: Erro interno do servidor

### Erros Espec√≠ficos de Cadastro
- `"Lead n√£o est√° apto a seguir no cadastro"`: Lead n√£o qualificado
- `"Contact with email X already exists"`: Email j√° existe
- `"already exist lead, try update lead - X"`: Telefone j√° existe

### Exemplo de Tratamento
```python
try:
    resultado = await cadastrar_lead({"dados_lead": dados_lead})
    print(f"Lead criado com sucesso")
except Exception as e:
    if "Lead n√£o est√° apto" in str(e):
        print("Lead n√£o qualificado - verifique regi√£o e valor da conta")
    elif "already exists" in str(e):
        print("Lead j√° existe - use dados √∫nicos")
    elif "422" in str(e):
        print("Dados de valida√ß√£o inv√°lidos")
    else:
        print(f"Erro ao cadastrar lead: {e}")
```

## üîí Seguran√ßa

### Boas Pr√°ticas
- ‚úÖ A chave de API √© carregada de vari√°vel de ambiente
- ‚úÖ Todas as requisi√ß√µes incluem autentica√ß√£o Bearer Token
- ‚úÖ N√£o armazene credenciais no c√≥digo fonte
- ‚úÖ Use HTTPS para todas as comunica√ß√µes
- ‚úÖ Valide todos os dados de entrada

### Configura√ß√£o de Seguran√ßa
```bash
# Configure as vari√°veis de ambiente
export PARTNERSHIP_API_KEY="sua_chave_aqui"
export PARTNERSHIP_API_ENDPOINT="https://partnership-service-staging.api.srna.co/"
```

## üìà Monitoramento e Logs

### Logs Dispon√≠veis
- Requisi√ß√µes HTTP com timestamps
- Erros de valida√ß√£o
- Tempo de resposta das APIs
- Status de autentica√ß√£o

### Exemplo de Log
```
[2024-01-15 10:30:45] INFO: Requisi√ß√£o para /sales-conversion/leads
[2024-01-15 10:30:46] INFO: Lead criado com sucesso - ID: lead_123456
[2024-01-15 10:30:47] INFO: Tempo de resposta: 1.2s
```

## üß™ Testes

### Testando as Ferramentas
```python
# Teste b√°sico de conectividade
areas = await consultar_areas_operacao_gd(cidade="S√£o Paulo", estado="SP")
assert areas is not None
assert len(areas["result"]) > 0

# Teste de qualifica√ß√£o
qualificacao = await validar_qualificacao_lead(
    cidade="Recife",
    estado="PE",
    tipo_pessoa="natural",
    valor_conta=800.00
)
assert qualificacao["result"]["qualification"] == True

# Teste de cadastro de lead (com dados √∫nicos)
lead_data = {
    "fullName": "Teste MCP",
    "personType": "natural",
    "emailAddress": f"teste.{timestamp}@mcp.com",
    "mobilePhone": f"1199988{timestamp}",
    "utilityBillHolder": "natural",
    "utilityBillingValue": 800.00,
    "identificationNumber": "12345678901",
    "nationality": "Brasileiro",
    "maritalStatus": "Solteiro",
    "profession": "Engenheiro",
    "zipCode": "50030-230",
    "state": "PE",
    "city": "Recife",
    "street": "Avenida Conde da Boa Vista",
    "number": "800",
    "neighborhood": "Boa Vista"
}
lead = await cadastrar_lead({"dados_lead": lead_data})
assert lead is not None
```

## üìû Suporte

### Recursos de Ajuda
- **Documenta√ß√£o da API**: Consulte `api-documentation.md`
- **Issues**: Abra issues no reposit√≥rio para bugs ou melhorias
- **Equipe de Desenvolvimento**: Entre em contato para suporte t√©cnico

### Informa√ß√µes de Contato
- **Email**: dev@serena.co
- **Slack**: #serena-partnerships-api
- **Documenta√ß√£o**: https://docs.serena.co/partnerships

## üîÑ Vers√µes e Changelog

### v1.0.0 (Atual)
- ‚úÖ Implementa√ß√£o completa das 9 ferramentas MCP
- ‚úÖ Suporte a leads pessoa f√≠sica e jur√≠dica
- ‚úÖ Valida√ß√£o de qualifica√ß√£o
- ‚úÖ Cria√ß√£o de contratos
- ‚úÖ Tratamento robusto de erros
- ‚úÖ Documenta√ß√£o completa com valida√ß√µes de neg√≥cio
- ‚úÖ Exemplos pr√°ticos de uso

### Pr√≥ximas Vers√µes
- üîÑ Suporte a webhooks
- üîÑ Cache de consultas frequentes
- üîÑ M√©tricas de performance
- üîÑ Suporte a m√∫ltiplos ambientes

---

**Desenvolvido pela Equipe Serena** üöÄ 